{"title":"Mumble Link for Java using JNA?","pubDate":"2013-07-15T17:42:01.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA","comments":[{"pubDate":"2013-07-19T21:54:35.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2447019","author":"Lulan.8497","body":"\n<p>Okay nice<img src=\"/include/images/smilies/smile.png\"> As it finally works now im very grateful for your support! I think i will integrate it into my yagw2api project and publish it in the near future. if any one is interested in it before, just contact me<img src=\"/include/images/smilies/smile.png\"></p>","arenanet":false},{"pubDate":"2013-07-19T21:38:51.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2446914","author":"Wothor.4781","body":"\n<p>Ah I see, they reference to GetLastError returns ERROR_ALREADY_EXISTS for checks. Well then.</p>","arenanet":false},{"pubDate":"2013-07-19T21:14:09.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2446739","author":"Healix.5819","body":"\n<p>JNA’s Open/CreateFileMapping is simplified. By default, it’s actually OpenFileMapping. If that fails, it becomes CreateFileMapping.</p>","arenanet":false},{"pubDate":"2013-07-19T20:37:39.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2446491","author":"Lulan.8497","body":"\n<p>PAGE_EXECUTE_READWRITE worked out<img src=\"/include/images/smilies/smile.png\"></p>\n<p>The problem with open is that the platform component of JNA does not provide the OpenFileMapping method…</p>","arenanet":false},{"pubDate":"2013-07-19T18:58:41.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2445840","author":"Wothor.4781","body":"\n<p>I’d still try to open it first, before I create it.</p>\n<p><a href=\"http://msdn.microsoft.com/en-us/library/windows/desktop/aa366537(v=vs.85).aspx\">http://msdn.microsoft.com/en-us/library/windows/desktop/aa366537(v=vs.85).aspx</a><br>\nIf the object exists before the function call, the function returns a handle to the existing object (with its current size, not the specified size), and GetLastError returns ERROR_ALREADY_EXISTS.</p>\n<p>Just creating it would, as I read it, render it incompatible to simultaneously running applications, like the Mumble client or the CrossTalk TS3-Addon.</p>\n<p>Also, I dunno why one would want to add execute to the standard implementation’s PAGE_READWRITE.</p>","arenanet":false},{"pubDate":"2013-07-19T18:49:15.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2445786","author":"Healix.5819","body":"\n<p>You created it as a read only memory. You need to change it back to PAGE_EXECUTE_READWRITE, like you had originally.</p>\n<blockquote><div class=\"quotey\"><p>CreateFileMapping(WinBase.INVALID_HANDLE_VALUE, null, WinNT.PAGE_EXECUTE_READWRITE, 0, MEM_MAP_SIZE, MEM_MAP_NAME);</p></div></blockquote>\n<blockquote><div class=\"quotey\"><p>HANDLE sharedFile = Kernel32.INSTANCE.CreateFileMapping(WinBase.INVALID_HANDLE_VALUE, null, WinNT.PAGE_EXECUTE_READWRITE, 0, 5460, “MumbleLink”);<br>\n   Pointer sharedMemory = Kernel32.INSTANCE.MapViewOfFile(sharedFile, WinNT.SECTION_MAP_READ, 0, 0, 5460);<br>\n   System.out.println(Arrays.toString(sharedMemory.getByteArray(0, 48)));</p></div></blockquote>","arenanet":false},{"pubDate":"2013-07-19T18:23:15.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2445622","author":"Wothor.4781","body":"\n<p>It’s not really my expertise, since I only used it in c++ for CrossTalk yet before I switched over to the Qt variant, but imo<br>\nCreateFileMapping(<br>\nWinBase.INVALID_HANDLE_VALUE, null, WinNT.PAGE_READONLY, 0,<br>\n5460, name)<br>\nlooks rather suspicious.<br>\nAren’t you creating a File Mapping that’s protected for read-only access? I figure GW2 would not be able to write to that then.</p>\n<p>Shouldn’t just recreating the exact same variant that Mumble Link itself uses:<br>\nTry to open file mapping, if not create file mapping (read/write access) be the way to go?</p>\n<div class=\"spoiler_container\"><div class=\"spoileroncontainer\"><button type=\"button\" class=\"button spoileron\" title=\"Click to show the spoiler.\">Show Spoiler</button></div><div class=\"spoiler\"><div class=\"spoileroffcontainer\"><button type=\"button\" class=\"button spoileroff\" title=\"Click to hide the spoiler.\">hide spoiler</button><br></div><div class=\"spoilertext\"><p>hMapObject = OpenFileMapping(FILE_MAP_ALL_ACCESS, FALSE, L\"MumbleLink\");<br>\n\t\t\tif (hMapObject == NULL) {<br>\n\t\t\t\thMapObject = CreateFileMapping(INVALID_HANDLE_VALUE, NULL, PAGE_READWRITE, 0, sizeof(LinkedMem), L\"MumbleLink\");<br>\n\t\t\t\tbCreated = true;<br>\n\t\t\t\tif (hMapObject == NULL)<br>\n\t\t\t\t\treturn false;<br>\n\t\t\t}<br>\n\t\t\tlm = static_cast&lt;LinkedMem *&gt;(MapViewOfFile(hMapObject, FILE_MAP_ALL_ACCESS, 0, 0, 0));</p></div></div></div><p>The access rights in OpenFileMapping and/or MapViewOfFile could probably indeed be opted to some sort of read access, unless you want to imitate Link’s unlock function, which I’d rather do not.</p>","arenanet":false},{"pubDate":"2013-07-19T17:47:02.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2445384","author":"Lulan.8497","body":"\n<p>Thank you for your answers<br>\nI put those correction into again a short example… well the result is still…. a bunch of zeros…<br>\nIs it possible, that i ran into some permission/security issues?</p>\n<pre><code>\nimport java.util.Arrays;\n\nimport com.sun.jna.Pointer;\nimport com.sun.jna.platform.win32.Kernel32;\nimport com.sun.jna.platform.win32.WinBase;\nimport com.sun.jna.platform.win32.WinNT;\nimport com.sun.jna.platform.win32.WinNT.HANDLE;\n\npublic class JNATest {\n\tprivate static final int MEM_MAP_SIZE = 5460;\n\tprivate static final String MEM_MAP_NAME = \"MumbleLink\";\n\tprivate final HANDLE sharedFile;\n\tprivate Pointer sharedMemory;\n\n\tpublic JNATest() throws InterruptedException {\n\n\t\tint uiVersion = 0;\n\t\tint uiTick = 0;\n\t\tfloat[] fAvatarPosition = new float[0];\n\t\tfloat[] fAvatarFront = new float[0];\n\t\tfloat[] fAvatarTop = new float[0];\n\t\tfloat[] fCameraPosition = new float[0];\n\t\tfloat[] fCameraFront = new float[0];\n\t\tfloat[] fCameraTop = new float[0];\n\t\tchar[] characterName = new char[0];\n\t\tchar[] gameName = new char[0];\n\t\tint context_len = 0;\n\t\tbyte[] context = new byte[0];\n\n\t\tthis.sharedFile = Kernel32.INSTANCE.CreateFileMapping(WinBase.INVALID_HANDLE_VALUE, null, WinNT.PAGE_EXECUTE_READWRITE, 0, MEM_MAP_SIZE, MEM_MAP_NAME);\n\t\tthis.sharedMemory = Kernel32.INSTANCE.MapViewOfFile(this.sharedFile, WinNT.SECTION_MAP_READ, 0, 0, MEM_MAP_SIZE);\n\t\twhile (this.sharedMemory != null) {\n\t\t\tuiVersion = this.sharedMemory.getInt(0);\n\t\t\tuiTick = this.sharedMemory.getInt(4);\n\t\t\tfAvatarPosition = this.sharedMemory.getFloatArray(8, 3);\n\t\t\tfAvatarFront = this.sharedMemory.getFloatArray(20, 3);\n\t\t\tfAvatarTop = this.sharedMemory.getFloatArray(32, 3);\n\t\t\tgameName = this.sharedMemory.getCharArray(44, 256);\n\t\t\tfCameraPosition = this.sharedMemory.getFloatArray(556, 3);\n\t\t\tfCameraFront = this.sharedMemory.getFloatArray(568, 3);\n\t\t\tfCameraTop = this.sharedMemory.getFloatArray(580, 3);\n\t\t\tcharacterName = this.sharedMemory.getCharArray(592, 256);\n\t\t\tcontext_len = this.sharedMemory.getInt(1104);\n\t\t\tcontext = this.sharedMemory.getByteArray(1108, 256);\n\t\t\tSystem.out.println(\"uiVersion: \" + uiVersion);\n\t\t\tSystem.out.println(\"uiTick: \" + uiTick);\n\t\t\tSystem.out.println(\"fAvatarPosition: \" + Arrays.toString(fAvatarPosition));\n\t\t\tSystem.out.println(\"fAvatarFront: \" + Arrays.toString(fAvatarFront));\n\t\t\tSystem.out.println(\"fAvatarTop: \" + Arrays.toString(fAvatarTop));\n\t\t\tSystem.out.println(\"gameName: \" + Arrays.toString(gameName));\n\t\t\tSystem.out.println(\"fCameraPosition: \" + Arrays.toString(fCameraPosition));\n\t\t\tSystem.out.println(\"fCameraFront: \" + Arrays.toString(fCameraFront));\n\t\t\tSystem.out.println(\"fCameraTop: \" + Arrays.toString(fCameraTop));\n\t\t\tSystem.out.println(\"identity: \" + Arrays.toString(characterName));\n\t\t\tSystem.out.println(\"context_len: \" + context_len);\n\t\t\tSystem.out.println(\"context: \" + Arrays.toString(context));\n\t\t\tSystem.out.println(\"#####################################################\");\n\t\t\tThread.sleep(1000);\n\t\t}\n\t}\n\n\tpublic static void main(String[] args) throws InterruptedException {\n\t\tnew JNATest();\n\t}\n}\n</code></pre>\n<p>Edit:<br>\nIt turned out, that if mumble client first creates the mem mapped file and i start my java application after that file is already created, everything works….<br>\nDo i need some security settings to get the creation by my java app work?</p>\n<p>Edit:<br>\nWhen using PAGE_EXECUTE_READWRITE it works as expected. -&gt; altered code above</p>","arenanet":false},{"pubDate":"2013-07-19T14:18:26.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2444132","author":"Much.2794","body":"\n<blockquote><div class=\"citey\"><cite title=\"Posted on July 19 2013 01:33PM\"><a href=\"/forum/community/api/Mumble-Link-for-Java-using-JNA/2443918\">Healix.5819:</a></cite></div><div class=\"quotey\"><blockquote><div class=\"citey\"><cite title=\"Posted on July 19 2013 12:47PM\"><a href=\"/forum/community/api/Mumble-Link-for-Java-using-JNA/2443704\">Much.2794:</a></cite></div><div class=\"quotey\"><p>Pointer sharedMemory = Kernel32.INSTANCE.MapViewOfFile(sharedFile,<br>\n\tWinNT.SECTION_MAP_WRITE, 0, 0, 5460);</p></div></blockquote>\n<p>That SECTION_MAP_WRITE means you’re opening the mapping with write/read access. It doesn’t really matter, but since you only need to read the data, that WRITE should be a READ.</p></div></blockquote>\n<p>Edited in my post and also changed the Kernel32.INSTANCE.CreateFileMapping to readonly</p>","arenanet":false},{"pubDate":"2013-07-19T13:33:42.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2443918","author":"Healix.5819","body":"\n<blockquote><div class=\"citey\"><cite title=\"Posted on July 19 2013 12:47PM\"><a href=\"/forum/community/api/Mumble-Link-for-Java-using-JNA/2443704\">Much.2794:</a></cite></div><div class=\"quotey\"><p>Pointer sharedMemory = Kernel32.INSTANCE.MapViewOfFile(sharedFile,<br>\n\tWinNT.SECTION_MAP_WRITE, 0, 0, 5460);</p></div></blockquote>\n<p>That SECTION_MAP_WRITE means you’re opening the mapping with write/read access. It doesn’t really matter, but since you only need to read the data, that WRITE should be a READ.</p>","arenanet":false},{"pubDate":"2013-07-19T12:47:38.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2443704","author":"Much.2794","body":"\n<p>I got it working with a few changes to you’re setup.</p>\n<p>Here are a few lines from the working code:</p>\n<p>final String name = “MumbleLink”;</p>\n<p>sharedFile = Kernel32.INSTANCE.CreateFileMapping(<br>\n\tWinBase.INVALID_HANDLE_VALUE, null, WinNT.PAGE_READONLY, 0,<br>\n\t5460, name);</p>\n<p>Pointer sharedMemory = Kernel32.INSTANCE.MapViewOfFile(sharedFile,<br>\n\tWinNT.SECTION_MAP_READ, 0, 0, 5460);</p>\n<p>if (sharedMemory != null) {<br>\n\tuiVersion = sharedMemory.getInt(0);<br>\n\tuiTick = sharedMemory.getInt(4);<br>\n\tfAvatarPosition = sharedMemory.getFloatArray(8, 3);<br>\n\tfAvatarFront = sharedMemory.getFloatArray(20, 3);<br>\n\tfAvatarTop = sharedMemory.getFloatArray(32, 3);<br>\n\tname = sharedMemory.getCharArray(44, 256);<br>\n\tfCameraPosition = sharedMemory.getFloatArray(556, 3);<br>\n\tfCameraFront = sharedMemory.getFloatArray(568, 3);<br>\n\tfCameraTop = sharedMemory.getFloatArray(580, 3);</p>\n<p>identity = sharedMemory.getCharArray(592, 256);<br>\n\tcontext_len = sharedMemory.getInt(1104);<br>\n\tcontext = sharedMemory.getByteArray(1108, 256);<br>\n}</p>\n<p>If the code still returns a lot of “0” play the game for a few seconds and the values will change.</p>","arenanet":false},{"pubDate":"2013-07-18T20:36:15.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2439358","author":"Heimdall.4510","body":"\n<p>Have you already tried to create the shared Memory section with just “MumbleLink” instead of “/MumbleLink”? – ah not fast enough…</p>","arenanet":false},{"pubDate":"2013-07-18T20:33:05.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2439340","author":"Lulan.8497","body":"\n<p>I compared the address and size of the memory mapped file that is created by the mumble client with the one created by my own.</p>\n<p>0xFFFFF8A00A581810 vs. 0xFFFFF8A00A581810</p>\n<p>They are the same….</p>","arenanet":false},{"pubDate":"2013-07-18T20:31:32.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2439325","author":"Healix.5819","body":"\n<p>GW2 will not create MumbleLink. If it has been created and GW2 is logged in with a character, it will open and begin writing to it. If you’re in a scenario where GW2 is running and doesn’t have MumbleLink open, then either MumbleLink hasn’t been created or it’s been created in a way which GW2 cannot open and write to it.</p>\n<p>Judging by the code in the first post, I see 3 errors.</p>\n<p>1. Remove the / in “/MumbleLink”<br>\n2. Your mapping doesn’t allocate enough space, change each 48 to 5460<br>\n3. You’re not actually reading, change WinNT.SECTION_QUERY to WinNT.SECTION_MAP_READ</p>","arenanet":false},{"pubDate":"2013-07-18T19:57:22.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2439083","author":"Lulan.8497","body":"\n<p>I found out, that when there is a Mumble client running an i than start my java application, i’m able to retrieve the data i wish…. Any ideas why?</p>\n<p>Edit:<br>\nRestartet IDE, Mumble, Eclipse and Java App —&gt; it doesnt work again</p>","arenanet":false},{"pubDate":"2013-07-18T19:06:31.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2438691","author":"Lulan.8497","body":"\n<p>Hello Guys,</p>\n<p>since i got no answers here, i investigated the whole problem a bit more by myself.</p>\n<p>I used Microsofts Process Explorer (<a href=\"http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx\">http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx</a>) to check which memory mapped files are opened by which process.</p>\n<p>I found out, that my java process has opened “\\Sessions\\1\\BaseNamedObjects\\MumbleLink” and the GW2 Process not.</p>\n<p>Is that the expected behavior?</p>\n<p>I executed my java app with elevated rights an got access to global scope…<br>\nthat resulted in a ememory mapped file handle \\BaseNamedObjects\\MumbleLink … well… it didn’t worked out as well..</p>","arenanet":false},{"pubDate":"2013-07-15T17:42:01.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/Mumble-Link-for-Java-using-JNA/2417778","author":"Lulan.8497","body":"\n<p>Hey,</p>\n<p>did anybody figured out how to establish a Mumble Link for position retrieval using JNA (Java Native Access)?</p>\n<p>Im stuck… I tried several different setups… Anyway… my current one looks similar to this:</p>\n<p>import com.sun.jna.Pointer;<br>\nimport com.sun.jna.platform.win32.Kernel32;<br>\nimport com.sun.jna.platform.win32.WinBase;<br>\nimport com.sun.jna.platform.win32.WinNT;<br>\nimport com.sun.jna.platform.win32.WinNT.HANDLE;</p>\n<p>HANDLE sharedFile = Kernel32.INSTANCE.CreateFileMapping(WinBase.INVALID_HANDLE_VALUE, null, WinNT.PAGE_EXECUTE_READWRITE, 0, 48, “/MumbleLink”);<br>\nPointer sharedMemory = Kernel32.INSTANCE.MapViewOfFile(this.sharedFile, WinNT.SECTION_QUERY, 0, 0, 48);<br>\n\t\t\t\tfinal int ret = Kernel32.INSTANCE.WaitForSingleObject(sharedFile, WinBase.INFINITE);\t\t\t\tSystem.out.println(Arrays.toString(sharedMemory.getByteArray(0, 48)));</p>\n<p>But all i get is a bunch of zeros xD</p>\n<p>Here is some small java test class you might start from …</p>\n<pre><code>\nimport java.util.Arrays;\n\nimport com.sun.jna.Pointer;\nimport com.sun.jna.platform.win32.Kernel32;\nimport com.sun.jna.platform.win32.WinBase;\nimport com.sun.jna.platform.win32.WinNT;\nimport com.sun.jna.platform.win32.WinNT.HANDLE;\n\npublic class JNATest {\n\tprivate final HANDLE sharedFile;\n\tprivate final Pointer sharedMemory;\n\n\tpublic JNATest() {\n\t\t// final String name = \"MumbleLink.\" + ManagementFactory.getRuntimeMXBean().getName().split(Pattern.quote(\"@\"))[0];\n\t\tfinal String name = \"MumbleLink\";\n\t\tSystem.out.println(\"filename: \" + name);\n\n\t\tthis.sharedFile = Kernel32.INSTANCE.CreateFileMapping(WinBase.INVALID_HANDLE_VALUE, null, WinNT.PAGE_READWRITE, 0, 48, name);\n\t\tthis.sharedMemory = Kernel32.INSTANCE.MapViewOfFile(this.sharedFile, WinNT.SECTION_MAP_WRITE, 0, 0, 48);\n\n\t\ttry {\n\t\t\twhile (true) {\n\t\t\t\tSystem.out.println(Arrays.toString(this.sharedMemory.getByteArray(0, 48)));\n\t\t\t\tThread.sleep(1000);\n\t\t\t}\n\t\t} catch (InterruptedException e) {\n\t\t\te.printStackTrace();\n\t\t} finally {\n\t\t\tif (!WinBase.INVALID_HANDLE_VALUE.equals(this.sharedFile)) {\n\t\t\t\tKernel32.INSTANCE.CloseHandle(this.sharedFile);\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic static void main(String[] args) throws InterruptedException {\n\t\tnew JNATest();\n\t}\n}\n</code></pre>","arenanet":false}]}