{"title":"PHP-SQL script takes >9hrs to complete db","pubDate":"2014-10-07T18:25:32.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db","comments":[{"pubDate":"2014-10-11T10:23:53.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4479642","author":"AysonCurrax.3254","body":"\n<blockquote><div class=\"citey\"><cite title=\"Posted on October 11 2014 10:05AM\"><a href=\"/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4479612\">StevenL.3761:</a></cite></div><div class=\"quotey\"><p>Getting the item details db schema right is pretty difficult. But even if you nailed the design, filling your perfectly designed database with API data has its own challenges.</p>\n<p>Some items contain references to other entities that may not already be in your database. Examples include upgradable items that reference upgrade item details, recipe sheets that reference recipe details, and dyes that reference color details.</p>\n<p>Trying to insert an item like that results in an integrity constraint violation, because the referenced item doesn’t exist in the database. So what do you do? You insert the referenced entity first, and then insert the item that holds the reference.</p>\n<p>The opposite can also happen. Multiple combat items can reference the same upgrade item. Trying to insert the referenced upgrade item results in a duplicate key violation, because the referenced item already exists in the database. So what do you do? Some database engines provide an option to silently ignore duplicate key errors. For the ones that don’t provide that option, change the query to insert only if the key doesn’t exist already.</p>\n<p>Long story short… the code can (will) get pretty messy, and it’s not your fault.</p></div></blockquote>\n<p>oh god i saved myself that trouble by just not bothering to add constraints for upgrade_items and such. Id much rather toss a second SQL query to grab that bunch of info at my DB that making my data import systematics even more complicated than they already are.</p>\n<p>I mean, mapping the v1/item_details to a database scheme was already bad enough by itself.</p>\n<p><a href=\"http://gw2compendium.com/resources/items.png\">http://gw2compendium.com/resources/items.png</a> <br>\n-cough-<br>\nthis is not the final result as I noticed some mistakes with it, per se, all name/description/suffix tables have a composite primary key with a lang field instead of having a column for each lang version of the string in one row.<br>\nAlso, that completely non working relationship between item_infusion_slot and item_armor, item_weapon and such has been replaced with a jointable between each of those 4. probably still not the most beautiful solition, but it does its job.</p>","arenanet":false},{"pubDate":"2014-10-11T10:05:19.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4479612","author":"StevenL.3761","body":"\n<p>Getting the item details db schema right is pretty difficult. But even if you nailed the design, filling your perfectly designed database with API data has its own challenges.</p>\n<p>Some items contain references to other entities that may not already be in your database. Examples include upgradable items that reference upgrade item details, recipe sheets that reference recipe details, and dyes that reference color details.</p>\n<p>Trying to insert an item like that results in an integrity constraint violation, because the referenced item doesn’t exist in the database. So what do you do? You insert the referenced entity first, and then insert the item that holds the reference.</p>\n<p>The opposite can also happen. Multiple combat items can reference the same upgrade item. Trying to insert the referenced upgrade item results in a duplicate key violation, because the referenced item already exists in the database. So what do you do? Some database engines provide an option to silently ignore duplicate key errors. For the ones that don’t provide that option, change the query to insert only if the key doesn’t exist already.</p>\n<p>Long story short… the code can (will) get pretty messy, and it’s not your fault.</p>","arenanet":false},{"pubDate":"2014-10-10T17:35:56.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4478527","author":"anzenketh.3759","body":"\n<p>I am still a beginner in development. In a attempt to develop <a href=\"https://github.com/anzenketh/gw2-toolsdb\">a application</a> that is currently on hold as I am trying to figure out the best way to persist the details of a item into the database. I have decided to use the following wrapper. It is not quite on wiki yet(no write access):</p>\n<p><a href=\"https://github.com/EtienneLamoureux/durmand-scriptorium\">https://github.com/EtienneLamoureux/durmand-scriptorium</a></p>\n<p>It uses Guzzle to get the requests and I have got a full item database query down less then 5 Minutes.</p>","arenanet":false},{"pubDate":"2014-10-09T21:12:51.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4476910","author":"Alkyoneus.3917","body":"\n<p>@Smiley, ohh thanks, I see now in your code (not fluent in reading code);  So now I added that (<a href=\"http://pastebin.com/udZ9HMHP\">http://pastebin.com/udZ9HMHP</a>) it went down to 21 minutes, woo!! I expected like 30 minutes divided by 4 languages so around 7-8minutes like you mentioned, but i realised I also do some array calculations directly after so I figure that accounts for the extra 13-14 minutes.</p>\n<p>@Pat oh i see like this</p>\n<p><a href=\"https://api.guildwars2.com/v2/commerce/listings?page=0&page_size=2\">https://api.guildwars2.com/v2/commerce/listings?page=0&amp;page_size=2</a></p>\n<p>&lt;/v2/commerce/listings?page=1&amp;page_size=2&gt;; rel=next, <br>\n&lt;/v2/commerce/listings?page=0&amp;page_size=2&gt;; rel=self, <br>\n&lt;/v2/commerce/listings?page=0&amp;page_size=2&gt;; rel=first,<br>\n&lt;/v2/commerce/listings?page=11076&amp;page_size=2&gt;; rel=last</p>","arenanet":false},{"pubDate":"2014-10-09T16:31:00.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4476268","author":"Pat Cavit.9234","body":"\n<p>Or just using pagination + the Link headers we return (see <a href=\"https://tools.ietf.org/html/rfc5988\">https://tools.ietf.org/html/rfc5988</a> for a description)</p>","arenanet":true},{"pubDate":"2014-10-09T12:59:29.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4475857","author":"smiley.1438","body":"\n<p>You’re still requesting the data for each individual item, try using the “ids” parameter and receive the data in chunks of up to 200 items per request. Over here: <a href=\"https://github.com/codemasher/gw2-database/blob/master/classes/gw2items.class.php#L178\">https://github.com/codemasher/gw2-database/blob/master/classes/gw2items.class.php#L178</a></p>","arenanet":false},{"pubDate":"2014-10-09T12:13:30.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4475801","author":"Alkyoneus.3917","body":"\n<p>Woo got it down to 25min <a href=\"http://pastebin.com/BCvNeyzr\">http://pastebin.com/BCvNeyzr</a>; The rollingcurl.php I used is still a bit of a black box for me but it seems to work fine without the root certificate you mentioned.</p>","arenanet":false},{"pubDate":"2014-10-07T21:49:05.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4472699","author":"smiley.1438","body":"\n<p>I’m sure you’ll get below 30 min, RollingCurl is da bomb!<img src=\"/include/images/smilies/colondee.png\"></p>","arenanet":false},{"pubDate":"2014-10-07T21:45:43.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4472692","author":"Alkyoneus.3917","body":"\n<p>Wow this is stuff I would not have guessed in a million years;  thank you Smiley! I’ll tinker a bit and post an update later this week, if i can get it down to 30 min id be so happy<img src=\"/include/images/smilies/colondee.png\"></p>","arenanet":false},{"pubDate":"2014-10-07T18:57:39.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4472325","author":"smiley.1438","body":"\n<p>Yes, 9h to complete seems highly inefficient – it should actually not take longer than a couple minutes to complete when using the bulk feature. Yor script initiates a new (single) cURL instance for each request and doesn’t queue these up to process them asynchronous which means it has to wait for the whole lifecycle of one request until it fires another one. You might want to take a look at rolling (multi) curl and maybe also at my database project on GitHub which uses it. (takes about half an hour to download the whole items database in 4 languages on my very slow connection)</p>\n<p><a href=\"https://github.com/codemasher/gw2-database/blob/master/classes/rollingcurl.class.php\">https://github.com/codemasher/gw2-database/blob/master/classes/rollingcurl.class.php</a><br>\n<a href=\"https://github.com/codemasher/gw2-database/blob/master/classes/gw2items.class.php#L156\">https://github.com/codemasher/gw2-database/blob/master/classes/gw2items.class.php#L156</a></p>\n<p>€: also you need to connect through https since the http URL redirects you to the https one each time (which probably costs some time) – to make cURL work with https, you need to provide a CA root certificate: <a href=\"http://curl.haxx.se/ca/cacert.pem\">http://curl.haxx.se/ca/cacert.pem</a> by passing the parameters:</p>\n<p>CURLOPT_SSL_VERIFYPEER = true<br>\nCURLOPT_SSL_VERIFYHOST = 2<br>\nCURLOPT_CAINFO = ‘path/to/certificates.pem’</p>","arenanet":false},{"pubDate":"2014-10-07T18:25:32.000Z","guid":"http://forum-en.guildwars2.com/forum/community/api/PHP-SQL-script-takes-9hrs-to-complete-db/4472239","author":"Alkyoneus.3917","body":"\n<p>This is the 2nd time I’ve tinkered with php-sql and I made a small script to retrieve the items and their sell/buy info into my db so I can sort/rank the items.</p>\n<p>It works (yay!) but I feel its hugely inefficient because it takes like 9hours to completely copy TP info to my db is this normal? I don’t see where I can cut corners.</p>\n<p><a href=\"http://pastebin.com/JcZZZp98\">http://pastebin.com/JcZZZp98</a></p>\n<p>oh i run it in the cli queued as a cronjob</p>","arenanet":false}]}